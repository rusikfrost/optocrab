<!DOCTYPE html>
<html>
<head>
	<title>optocrab.ru</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css">
	<link rel="shortcut icon" href="/public/favicon.ico" type="image/x-icon">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/vue@2.5.22/dist/vue.js"></script>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

		<link href="https://fonts.googleapis.com/css?family=Caveat|Comfortaa|M+PLUS+Rounded+1c|Neucha|Poiret+One|Vollkorn" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="public/css/style.css">
</head>
<body>
<header>
	<h1>Optocrab.ru</h1>
	<b>+7(912)22-22-222</b>
</header>
<main>
<img class="header_img" src="https://cs8.pikabu.ru/post_img/big/2017/12/18/6/1513588165141395433.jpg">
<div class="btn-group admin_button">
    <button type="button" class="btn btn-info"> Отзывы </button>
    <button type="button" class="btn btn-info"> О нас </button>
    <button type="button" class="btn btn-info" @click="admin_open = !admin_open, hidden_admin = !hidden_admin"> Админка </button>
  </div> 
	<div class="go_home_static_class" :class="{description: admin_open, hidden_admin: hidden_admin}"><br><br>
		<b class="close" @click="admin_open = !admin_open, hidden_admin = !hidden_admin"> Х </b>
		<form action="/admin" method="post">
		<label> Введите логин </label><br>
		<input name="login" type="text"><br>
		<label> Введите Пароль </label><br>
		<input name="password" type="text"><br><br>
		<button type="submit" class="btn btn-info " @click="admin_send"> go </button>
		</form>

</div><div id="app"></div>
  <table>
    <template v-for="row in rows">
      <tr @click="toggle(row.id)" :class="{ opened: opened.includes(row.id) }" :id="'id'+row.id">
        <td><img :src="row.photo"></td>
        <td><b>{{ row.name }}</b></td>
        <td>{{ row.kg_in_pack }} кг</td>
        <td>{{ row.count }} шт.</td>
        <td>{{ row.price }} руб.</td>
        <td>{{ row.sum_price}} руб.</td>
        <td>{{ row.kg }} кг</td>
      </tr>
      <tr v-if="opened.includes(row.id)">
      	<div class="modal_background">
	        <td class="description" :id="'desc_id'+row.id" colspan="2">{{ row.description }}      
	        	<div class="buttons"> <b @click="toggle(row.id)"> Х </b>
	        		<div>
	        			<p>Всего: <input @click="input_number(row.id)" v-on:keyup="input_number(row.id)" type="number" v-model="row.count"> упаковок</p> <p>Общий вес: {{ row.kg }} кг</p> <p>Товар: {{ row.sum_price }} рублей</p> <p class="sum">Итого к оплате {{sum_full_price}} рублей</p>
	        		</div>
			     	<button type="button" @click="plus(row.id)" class="btn btn-info">Добавить ед.</button> 
			      	<button type="button" @click="minus(row.id)" class="btn btn-danger">Убрать ед.</button> 
		      	</div>
	  		</td>
	  	</div>
      </tr>
    </template>
  </table>
</div>
<div class="pay_block">
<form method="POST" action="https://money.yandex.ru/quickpay/confirm.xml">    
	<input type="hidden" name="receiver" value="410014146569625">    
	<input type="hidden" name="formcomment" :value="formcomment">    
	<input type="hidden" name="short-dest" :value="formcomment">   
	<input type="hidden" name="label" value="$order_id">    
	<input type="hidden" name="quickpay-form" value="donate">    
	<input type="hidden" name="targets" value="транзакция {order_id}">    
	<input type="hidden" id="val" name="sum" value="0" data-type="number">    
	<input type="hidden" name="comment" :value="formcomment">   
	<input type="hidden" name="need-fio" value="true">    
	<input type="hidden" name="need-email" value="true">   
	<input type="hidden" name="need-phone" value="true">    
	<input type="hidden" name="need-address" value="true">    
	<div class="ym_pay_button">
		<label><input type="radio" required name="paymentType" value="PC">Яндекс Деньгами</label>    
		<label><input type="radio" required name="paymentType" value="AC">Банковской картой</label>       
		<button onclick="y_val(vue.sum_full_price)" type="submit" class="btn btn-info">Оплатить {{sum_full_price}} рублей</button>
	</div>
</form>
	<button onclick="formcomment_fun() " class="btn btn-info go_home_button" @click="go_home = !go_home, hidden_go_home = !hidden_go_home">Оплатить наличными при получении</button>

<div class="go_home_static_class" v-bind:class="{ description: go_home, hidden_go_home: hidden_go_home}">
	<div class="buttons"> <b @click="hidden_go_home = true, go_home = false"> Х </b></div>
	<form action="/go_home" method="post">
	<label>Введите ФИО</label><br>
	<input type="text" required name="name" placeholder="Фамилия Имя Отчество"><br>
	<label>Введите номер телефона</label><br>
	<input type="phone" required name="phone" placeholder="+79XXXXXXXXX"><br>
	<label>Введите свой город ( только Краснодарский край и Адыгея )</label><br>
	<input type="text" required name="sity" placeholder="Город"><br>
	<label>Введите свой адрес</label><br>
	<input type="text" required name="adress" placeholder="Улица, Строение"><br>
	<label>Комментарий к заказу ( по желанию )</label><br>
	<textarea placeholder="Комментарий"></textarea><br>
	<input type="hidden" name="task" :value="formcomment">
	<button class="btn btn-info"> Отправить </button>

	</form>	 <b class="task">{{formcomment}}</b> 
</div>
</div></main>
<script>
	
const vue = new Vue({
	el: 'main',
	data: {
	  	opened: [],
	  	rows: [],
	  	sum_full_price: 0,
	  	double_rows: [],
	  	go_home: false,
	  	hidden_go_home: true,
	  	admin_open: false,
	  	hidden_admin: true,
	  	admin: {login: '', password: ''},
	  	formcomment: [],
  },
	  methods: {
	  	toggle(id) {
	    	const index = this.opened.indexOf(id);
	    	if (index > -1) {
		    	this.opened.splice(index, 1)
	    	} else {
		      	this.opened = [];
		      	this.opened.push(id)
	    	}
	    },
	    toggle_go_home: function(){
	    	this.go_home = true;
	    },
	    input_number: function(id){
	    	if (this.rows[id].count > 0){
		    	this.rows[id].sum_price = this.rows[id].count * this.rows[id].price * this.rows[id].kg_in_pack;
		    	this.rows[id].kg = this.rows[id].count * this.rows[id].kg_in_pack;
		    	full_price(this.rows[id].id)
	    	}
	    },
	    minus: function(id) {
	    	if (this.rows[id].count > 0){
		    	this.rows[id].count = this.rows[id].count - 1;
		    	this.rows[id].sum_price = this.rows[id].sum_price - this.rows[id].price * this.rows[id].kg_in_pack;
		    	this.rows[id].kg = this.rows[id].kg - this.rows[id].kg_in_pack;
		    	full_price(this.rows[id].id)
	    	}
	    },
	    plus: function(id) {
	    		this.rows[id].count = Number(this.rows[id].count);
		    	this.rows[id].count = this.rows[id].count + 1;
		    	this.rows[id].sum_price = this.rows[id].count * this.rows[id].price * this.rows[id].kg_in_pack;
		    	this.rows[id].kg = this.rows[id].count * this.rows[id].kg_in_pack;
		    	full_price(this.rows[id].id, this.rows[id].name, this.rows[id].id,)
	    	},
	    admin_send: function() {
	    		axios.post('/admin', {
			    	login: this.admin.login,
			    	password: this.admin.password
			    })
	   		},
	  	},
	  	mounted() {
	    axios.post('/products')
	        .then(function (response) {
	    console.log(response.data);
	    vue.rows = response.data;
	  })
  }
});

function full_price(f){
	vue.double_rows = vue.rows.slice();
	var arr = vue.double_rows;

	arr.reduce(function (a, b) {
		if (arr[0].id === 0){
			arr.splice(0, 1);
	  		return {sum_price: a.sum_price + b.sum_price};
		} else {
			return {sum_price: a.sum_price + b.sum_price};
		}	
	})
	console.log(arr.reduce((a, b) => ({sum_price: a.sum_price + b.sum_price})));
	var spr = arr.reduce((a, b) => ({sum_price: a.sum_price + b.sum_price})); 
	vue.sum_full_price = spr.sum_price;
	console.log(spr.sum_price + '------')
	vue.submit_button_value = 'Оплатить '+spr.sum_price+' рублей';

vue.formcomment = [];



}

function formcomment_fun() {
	i=1;
while (i < vue.rows.length) {
	var formcomment_arry = vue.rows[i].kg + ' kg ' + vue.rows[i].name + ' - ' + vue.rows[i].count + ' упаковок на ' + vue.rows[i].sum_price + ' рублей' 
 	vue.formcomment.push(formcomment_arry);

 //	if (vue.rows[i].count > 3){
 	//	vue.rows[i].sum_price = vue.rows[i].sum_price - vue.rows[i].sum_price * 0.3;
 	//} 

  i++;
}
}

function y_val(yv) {
	document.getElementById("val").value = yv + ".00";
	console.log(yv)
	formcomment_fun()
}

</script>
</body>
</html>